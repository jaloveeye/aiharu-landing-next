name: AI ë‰´ìŠ¤ ìˆ˜ì§‘

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 4ì‹œ (UTC ê¸°ì¤€)ì— ì‹¤í–‰ (í•œêµ­ì‹œê°„ ì˜¤ì „ 1ì‹œ)
    - cron: "0 4 * * *"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        run: |
          echo "í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì¤‘..."
          if [ -z "$OPENAI_API_KEY" ]; then echo "âŒ OPENAI_API_KEY ëˆ„ë½"; else echo "âœ… OPENAI_API_KEY ì„¤ì •ë¨"; fi
          if [ -z "$NEWS_API_KEY" ]; then echo "âŒ NEWS_API_KEY ëˆ„ë½"; else echo "âœ… NEWS_API_KEY ì„¤ì •ë¨"; fi
          if [ -z "$GNEWS_API_KEY" ]; then echo "âŒ GNEWS_API_KEY ëˆ„ë½"; else echo "âœ… GNEWS_API_KEY ì„¤ì •ë¨"; fi
          if [ -z "$SUPABASE_URL" ]; then echo "âŒ SUPABASE_URL ëˆ„ë½"; else echo "âœ… SUPABASE_URL ì„¤ì •ë¨"; fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then echo "âŒ SUPABASE_SERVICE_ROLE_KEY ëˆ„ë½"; else echo "âœ… SUPABASE_SERVICE_ROLE_KEY ì„¤ì •ë¨"; fi

      - name: ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹¤í–‰
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸš€ AI ë‰´ìŠ¤ ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘..."
          echo "ì‹¤í–‰ ì‹œê°„: $(date)"
          echo "í˜„ì¬ ì‹œê°„ëŒ€: $(date +%Z)"
          echo "UTC ì‹œê°„: $(date -u)"
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          node scripts/collect-ai-news.js
          
          echo "âœ… ë‰´ìŠ¤ ìˆ˜ì§‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ"

      - name: ê²°ê³¼ ë¡œê·¸
        if: always()
        run: |
          echo "ğŸ“Š ë‰´ìŠ¤ ìˆ˜ì§‘ ì‘ì—… ì™„ë£Œ ìƒíƒœ:"
          echo "ì™„ë£Œ ì‹œê°„: $(date)"
          echo "ì›Œí¬í”Œë¡œìš° ìƒíƒœ: ${{ job.status }}"
